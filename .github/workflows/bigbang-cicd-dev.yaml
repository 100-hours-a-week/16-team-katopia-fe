name: CI/CD (dev) - Next.js

on:
  push:
    branches: ["dev"]

# github.ref는 refs/heads/dev이므로 다른 브랜치와 관련 없습니다.
concurrency:
  group: cicd-dev-nextjs-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  ci-and-delivery:
    name: CI - Analyze/Test/Build + Archive + SCP
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout
        id: checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

  #     # npm 의존성 캐시: setup-node에서 처리
  #     - name: Set up Node 20 (+ npm dependency cache)
  #       id: setup_node
  #       uses: actions/setup-node@v4
  #       with:
  #         node-version: "20"
  #         cache: "npm"
  #         cache-dependency-path: |
  #           package-lock.json
  #           **/package-lock.json

  #     # "중간 산출물" 캐시 (Next.js 빌드 캐시)
  #     - name: Cache Next.js build cache (.next/cache)
  #       id: cache_next_cache
  #       uses: actions/cache@v4
  #       with:
  #         path: .next/cache
  #         key: next-cache-${{ runner.os }}-${{ hashFiles('package-lock.json', '**/package-lock.json', 'next.config.*', 'tsconfig.json') }}
  #         restore-keys: |
  #           next-cache-${{ runner.os }}-

  #     # 의존성 설치
  #     - name: Install dependencies
  #       id: npm_ci
  #       run: npm ci

  #     # 2) 코드 분석 4종: TypeScript / ESLint / Prettier / npm audit
  #     - name: TypeScript typecheck
  #       id: ts_typecheck
  #       run: npx tsc --noEmit

  #     # - name: ESLint
  #     #   id: eslint
  #     #   run: npm run lint

  #     # Prettier 없음.
  #     # - name: Prettier (check)
  #     #   id: prettier_check
  #     #   run: npx prettier --check .
  #     #   continue-on-error: true

  #     - name: npm audit (high+)
  #       id: npm_audit
  #       run: npm audit --audit-level=high

  #     # 3) 테스트 (단위), 현재 단위 테스트가 없습니다.
  #     # - name: Unit tests
  #     #   id: unit_tests
  #     #   run: npm run test:unit

  #     # 4) 빌드
  #     - name: Build (next build)
  #       id: build_next
  #       run: npm run build

  #     # 5) 압축 (node_modules, .git, .github 제외)
  #     - name: Archive
  #       id: archive
  #       shell: bash
  #       run: |
  #         rm -f bigbang_nextjs.tgz
  #         tar --exclude=.git \
  #             --exclude=.github \
  #             --exclude=node_modules \
  #             --exclude=.next/cache \
  #             --exclude=bigbang_nextjs.tgz \
  #             -czf bigbang_nextjs.tgz . || [ $? -eq 1 ]

  #     # 6) scp 전송
  #     - name: SCP to EC2
  #       id: scp_to_ec2
  #       shell: bash
  #       run: |
  #         mkdir -p ~/.ssh
  #         printf "%s" "${{ secrets.EC2_SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
  #         chmod 600 ~/.ssh/id_rsa

  #         scp -o StrictHostKeyChecking=no \
  #           -i ~/.ssh/id_rsa \
  #           bigbang_nextjs.tgz \
  #           ${{ secrets.EC2_USER }}@${{ secrets.DEV_EC2_PUBLIC_IP }}:/home/ec2-user/nextjs.tgz

  cd:
    name: CD - Deploy to Dev Server
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs: ci-and-delivery

    steps:
      # SSH 키 설정
      - name: Setup SSH key
        id: setup_ssh
        shell: bash
        run: |
          mkdir -p ~/.ssh
          printf "%s" "${{ secrets.EC2_SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.DEV_EC2_PUBLIC_IP }} >> ~/.ssh/known_hosts

      # 배포
      - name: Deploy to port 3000
        id: deploy
        shell: bash
        run: |
          ssh -i ~/.ssh/id_rsa "${{ secrets.EC2_USER }}@${{ secrets.DEV_EC2_PUBLIC_IP }}" << 'SSH'
            set -euo pipefail

            echo "=== Next.js 배포 시작 ==="

            # 1) 기존 서비스 중지
            if systemctl is-active --quiet nextjs-3000; then
              echo "기존 서비스 중지 중..."
              sudo systemctl stop nextjs-3000
            fi

            # 2) 배포 디렉토리 준비 및 압축 해제
            cd /home/ec2-user
            rm -rf nextjs
            mkdir -p nextjs
            tar -xzf nextjs.tgz -C nextjs/

            # 3) 의존성 설치
            cd nextjs
            export NODE_ENV=production
            export PORT=3000
            npm ci --production

            # 4) 서비스 시작
            echo "서비스 시작 (포트 3000)..."
            sudo systemctl start nextjs-3000

            echo "서비스 시작 대기 (10초)..."
            sleep 10

            echo "✅ 배포 완료"
          SSH

      # 1) 기동/프로세스 레벨: systemd 프로세스 확인
      - name: "Verify: 1) Process level (systemd)"
        id: verify_process
        shell: bash
        run: |
          ssh -i ~/.ssh/id_rsa "${{ secrets.EC2_USER }}@${{ secrets.DEV_EC2_PUBLIC_IP }}" << 'SSH'
            set -euo pipefail

            if ! systemctl is-active --quiet nextjs-3000; then
              echo "❌ 서비스 nextjs-3000이 실행 중이지 않음"
              exit 1
            fi

            echo "✅ 프로세스 검증 통과: nextjs-3000"
          SSH

      # 2) 헬스체크
      - name: "Verify: 2) Healthcheck"
        id: verify_health
        shell: bash
        run: |
          ssh -i ~/.ssh/id_rsa "${{ secrets.EC2_USER }}@${{ secrets.DEV_EC2_PUBLIC_IP }}" << 'SSH'
            set -euo pipefail

            echo "포트 3000 헬스체크..."

            # 헬스체크 (최대 30초)
            for i in {1..10}; do
              if curl -fsS "http://localhost:3000/" > /dev/null 2>&1; then
                echo "✅ 헬스체크 통과"
                exit 0
              fi
              echo "시도 $i/10..."
              sleep 3
            done

            echo "❌ 헬스체크 실패 (30초 초과)"
            exit 1
          SSH