name: CI/CD (dev) - Next.js

on:
  push:
    branches: ["dev"]

# github.refëŠ” refs/heads/devì…ë‹ˆë‹¤. ìƒˆë¡œìš´ í‘¸ì‹œê°€ ìˆì„ ë•Œë§ˆë‹¤ ê¸°ì¡´ ì§„í–‰ ì¤‘ì¸ ì›Œí¬í”Œë¡œìš°ë¥¼ ì·¨ì†Œí•©ë‹ˆë‹¤.
concurrency:
  group: cicd-dev-nextjs-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  ci-and-delivery:
    name: CI - Analyze/Test/Build + Archive + SCP
    runs-on: ubuntu-latest
    timeout-minutes: 10
    outputs:
      artifact_name: ${{ steps.prep_artifact.outputs.artifact_name }}

    steps:
      - name: Checkout
        id: checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      # npm ì˜ì¡´ì„± ìºì‹œ: setup-nodeì—ì„œ ì²˜ë¦¬
      - name: Set up Node 20 (+ npm dependency cache)
        id: setup_node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: |
            package-lock.json
            **/package-lock.json

      # "ì¤‘ê°„ ì‚°ì¶œë¬¼" ìºì‹œ (Next.js ë¹Œë“œ ìºì‹œ)
      - name: Cache Next.js build cache (.next/cache)
        id: cache_next_cache
        uses: actions/cache@v4
        with:
          path: .next/cache
          key: next-cache-${{ runner.os }}-${{ hashFiles('package-lock.json', '**/package-lock.json', 'next.config.*', 'tsconfig.json') }}
          restore-keys: |
            next-cache-${{ runner.os }}-

      # ì˜ì¡´ì„± ì„¤ì¹˜
      - name: Install dependencies
        id: npm_ci
        run: npm ci

      # 2) ì •ì  ì½”ë“œ ë¶„ì„
      # ì½”ë“œë¥¼ ì˜ˆì˜ê²Œ ë§Œë“¤ê¸°(ex: ì¤„ ë°”ê¿ˆ, ì„¸ë¯¸ì½œë¡  ì—¬ë¶€, ë”°ì˜´í‘œ ì¢…ë¥˜ ë“±)
      - name: Prettier (check)
        id: prettier_check
        run: npx prettier --check .
        continue-on-error: true # ì—ëŸ¬ ë¬´ì‹œ

      # ì½”ë“œë¥¼ ì˜¬ë°”ë¥´ê²Œ ë§Œë“¤ê¸°(ex: ì•ˆ ì“°ëŠ” ë³€ìˆ˜, ì„ ì–¸ ì „ í˜¸ì¶œ, ë…¼ë¦¬ì  ì˜¤ë¥˜ ë“±)
      - name: ESLint
        id: eslint
        run: npm run lint
        continue-on-error: true # ì—ëŸ¬ ë¬´ì‹œ

      # ts íƒ€ì… í™•ì¸
      - name: TypeScript typecheck
        id: ts_typecheck
        run: npx tsc --noEmit
        continue-on-error: true # ì—ëŸ¬ ë¬´ì‹œ

      # ë³´ì•ˆ ì·¨ì•½ì  íƒìƒ‰
      - name: npm audit (high+)
        id: npm_audit
        run: npm audit --audit-level=high

      # E2E í…ŒìŠ¤íŠ¸
      # - name: E2E tests
      #   id: e2e_tests
      #   run: |
      #     npx playwright install --with-deps  # ë¸Œë¼ìš°ì € ì—”ì§„ ì„¤ì¹˜
      #     npm run dev &                       # ì„œë²„ë¥¼ ë°±ê·¸ë¼ìš´ë“œì—ì„œ ì‹¤í–‰
      #     npx playwright test                 # E2E í…ŒìŠ¤íŠ¸ ìˆ˜í–‰

      # 4) ë¹Œë“œ
      - name: Build (next build)
        id: build_next
        run: npm run build
        env:
          NEXT_PUBLIC_API_BASE_URL: https://dev.fitcheck.kr
          NEXT_PUBLIC_IMAGE_BASE_URL: https://df1ez4kkj7703.cloudfront.net

      # 4.5) ì „ì†¡í•  ì••ì¶• íŒŒì¼ëª… ë§Œë“¤ê¸°
      - name: Prepare artifact filename (date + commit message)
        id: prep_artifact
        if: success()
        shell: bash
        run: |
          set -euo pipefail

          # KST ê¸°ì¤€ ë‚ ì§œ
          DATE="$(TZ=Asia/Seoul date +'%Y%m%d-%H%M%S')"

          # ì»¤ë°‹ ë©”ì‹œì§€ ìŠ¬ëŸ¬ê·¸ ìƒì„±
          MSG="$(printf "%s" "${{ github.event.head_commit.message }}" | head -n 1)"
          SLUG="$(printf "%s" "$MSG" \
            | tr '[:upper:]' '[:lower:]' \
            | sed -E 's/[^a-z0-9]+/-/g; s/^-+|-+$//g' \
            | cut -c1-60)"

          if [ -z "${SLUG}" ]; then SLUG="no-message"; fi

          # íŒŒì¼ëª… ì •ì˜ (í™•ì¥ì .tgz)
          TARGET_NAME="${DATE}_${SLUG}.tgz"

          # ì••ì¶• ì‹¤í–‰ (node_modules ì œì™¸)
          tar --exclude=.git \
              --exclude=.github \
              --exclude=node_modules \
              --exclude=.next/cache \
              --exclude="${TARGET_NAME}" \
              -czf "${TARGET_NAME}" . || [ $? -eq 1 ]

          echo "artifact_name=${TARGET_NAME}" >> "$GITHUB_OUTPUT"
          echo "âœ… Prepared: ${TARGET_NAME}"

      # 5) scp ì „ì†¡
      - name: SCP to EC2
        run: |
          mkdir -p ~/.ssh
          # ì„œë²„ì˜ í˜¸ìŠ¤íŠ¸ í‚¤ë¥¼ ë¯¸ë¦¬ ë“±ë¡
          ssh-keyscan -H ${{ secrets.DEV_SERVER_HOST }} >> ~/.ssh/known_hosts

          printf "%s" "${{ secrets.EC2_SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa

          ssh -i ~/.ssh/id_rsa ${{ secrets.EC2_USER }}@${{ secrets.DEV_SERVER_HOST }} "mkdir -p /home/ec2-user/nextjs"

          scp -i ~/.ssh/id_rsa "${{ steps.prep_artifact.outputs.artifact_name }}" \
          ${{ secrets.EC2_USER }}@${{ secrets.DEV_SERVER_HOST }}:/home/ec2-user/nextjs/

  cd:
    name: CD - Deploy to Dev Server
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs: ci-and-delivery

    steps:
      # SSH í‚¤ ì„¤ì •
      - name: Setup SSH key
        id: setup_ssh
        shell: bash
        run: |
          mkdir -p ~/.ssh
          printf "%s" "${{ secrets.EC2_SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.DEV_SERVER_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy to port 3000
        run: |
          ssh -i ~/.ssh/id_rsa "${{ secrets.EC2_USER }}@${{ secrets.DEV_SERVER_HOST }}" << 'SSH'
            set -euo pipefail

            NEXTJS_ROOT="/home/ec2-user/nextjs"
            CURRENT_LINK="$NEXTJS_ROOT/current"
            
            # ì´ì „ Jobì˜ outputì„ ê°€ì ¸ì˜µë‹ˆë‹¤.
            ARTIFACT_NAME="${{ needs.ci-and-delivery.outputs.artifact_name }}"
            RELEASE_NAME="${ARTIFACT_NAME%.tgz}"
            RELEASE_PATH="$NEXTJS_ROOT/$RELEASE_NAME"

            # pm2ê°€ ì—†ìœ¼ë©´ ì „ì—­ ì„¤ì¹˜
            if ! command -v pm2 &> /dev/null; then
              echo "pm2ê°€ ì„¤ì¹˜ë˜ì–´ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤. ì„¤ì¹˜ ì¤‘..."
              sudo npm install -g pm2
            fi

            echo "=== ë°°í¬ ì‹œì‘ (Flat êµ¬ì¡°) ==="

            mkdir -p "$RELEASE_PATH"
            tar -xzf "$NEXTJS_ROOT/$ARTIFACT_NAME" -C "$RELEASE_PATH"

            cd "$RELEASE_PATH"
            npm ci --production

            rm -rf "$CURRENT_LINK"
            ln -sfn "$RELEASE_PATH" "$CURRENT_LINK"

            pm2 describe nextjs > /dev/null 2>&1 \
              && pm2 reload nextjs --update-env \
              || pm2 start npm --name nextjs --cwd "$CURRENT_LINK" -- start
            
            pm2 save

            echo "ğŸ§¹ ì˜¤ë˜ëœ ë²„ì „ ì •ë¦¬ (ìµœì‹  2ê°œ ìœ ì§€)..."
            cd "$NEXTJS_ROOT"
            ls -1dt 20*/ | grep -v "current" | tail -n +3 | xargs -r rm -rf
            rm -f "$NEXTJS_ROOT/$ARTIFACT_NAME"
            
            echo "âœ… ë°°í¬ ì™„ë£Œ"
          SSH

      # 1) ê¸°ë™/í”„ë¡œì„¸ìŠ¤ ë ˆë²¨: PM2 í”„ë¡œì„¸ìŠ¤ í™•ì¸
      - name: "Verify: 1) Process level (PM2)"
        id: verify_process
        shell: bash
        run: |
          ssh -i ~/.ssh/id_rsa "${{ secrets.EC2_USER }}@${{ secrets.DEV_SERVER_HOST }}" << 'SSH'
            set -euo pipefail

            # PM2 í”„ë¡œì„¸ìŠ¤ ìƒíƒœ í™•ì¸
            if ! pm2 describe nextjs > /dev/null 2>&1; then
              echo "âŒ PM2 í”„ë¡œì„¸ìŠ¤ 'nextjs'ê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŒ"
              exit 1
            fi

            # í”„ë¡œì„¸ìŠ¤ê°€ online ìƒíƒœì¸ì§€ í™•ì¸
            STATUS=$(pm2 jlist | jq -r '.[] | select(.name=="nextjs") | .pm2_env.status')
            if [ "$STATUS" != "online" ]; then
              echo "âŒ í”„ë¡œì„¸ìŠ¤ ìƒíƒœê°€ onlineì´ ì•„ë‹˜: $STATUS"
              exit 1
            fi

            echo "âœ… í”„ë¡œì„¸ìŠ¤ ê²€ì¦ í†µê³¼: nextjs (status: $STATUS)"
          SSH

      # 2) í—¬ìŠ¤ì²´í¬
      - name: "Verify: 2) Healthcheck"
        id: verify_health
        shell: bash
        run: |
          ssh -i ~/.ssh/id_rsa "${{ secrets.EC2_USER }}@${{ secrets.DEV_SERVER_HOST }}" << 'SSH'
            set -euo pipefail

            echo "í¬íŠ¸ 3000 í—¬ìŠ¤ì²´í¬..."

            # í—¬ìŠ¤ì²´í¬ (ìµœëŒ€ 30ì´ˆ)
            for i in {1..10}; do
              if curl -fsS "http://localhost:3000/" > /dev/null 2>&1; then
                echo "âœ… í—¬ìŠ¤ì²´í¬ í†µê³¼"
                exit 0
              fi
              echo "ì‹œë„ $i/10..."
              sleep 3
            done

            echo "âŒ í—¬ìŠ¤ì²´í¬ ì‹¤íŒ¨ (30ì´ˆ ì´ˆê³¼)"
            exit 1
          SSH
