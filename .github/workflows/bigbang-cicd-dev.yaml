name: CI/CD (dev) - Next.js

on:
  push:
    branches: ["dev"]

# github.ref는 refs/heads/dev이므로 다른 브랜치와 관련 없습니다.
concurrency:
  group: cicd-dev-nextjs-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  ci-and-delivery:
    name: CI - Analyze/Test/Build + Archive + SCP
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout
        id: checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      # npm 의존성 캐시: setup-node에서 처리
      - name: Set up Node 20 (+ npm dependency cache)
        id: setup_node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: |
            package-lock.json
            **/package-lock.json

      # "중간 산출물" 캐시 (Next.js 빌드 캐시)
      - name: Cache Next.js build cache (.next/cache)
        id: cache_next_cache
        uses: actions/cache@v4
        with:
          path: .next/cache
          key: next-cache-${{ runner.os }}-${{ hashFiles('package-lock.json', '**/package-lock.json', 'next.config.*', 'tsconfig.json') }}
          restore-keys: |
            next-cache-${{ runner.os }}-

      # 의존성 설치
      - name: Install dependencies
        id: npm_ci
        run: npm ci

      # 2) 코드 분석 4종: TypeScript / ESLint / Prettier / npm audit
      # - name: TypeScript typecheck
      #   id: ts_typecheck
      #   run: npx tsc --noEmit

      # - name: ESLint
      #   id: eslint
      #   run: npm run lint

      # Prettier 없음.
      # - name: Prettier (check)
      #   id: prettier_check
      #   run: npx prettier --check .
      #   continue-on-error: true

      # - name: npm audit (high+)
      #   id: npm_audit
      #   run: npm audit --audit-level=high

      # 3) E2E 테스트
      # - name: E2E tests
      #   id: e2e_tests
      #   run: ls # 이후 정해지면 작성합니다.

      # 4) 빌드
      - name: Build (next build)
        id: build_next
        run: npm run build

      # 4.5) 전송할 압축 파일명 만들기
      - name: Prepare artifact filename (date + commit message)
        id: prep_artifact
        if: success()
        shell: bash
        run: |
          set -euo pipefail

          # KST 기준 날짜
          DATE="$(TZ=Asia/Seoul date +'%Y%m%d-%H%M%S')"

          # 커밋 메시지 슬러그 생성
          MSG="$(printf "%s" "${{ github.event.head_commit.message }}" | head -n 1)"
          SLUG="$(printf "%s" "$MSG" \
            | tr '[:upper:]' '[:lower:]' \
            | sed -E 's/[^a-z0-9]+/-/g; s/^-+|-+$//g' \
            | cut -c1-60)"

          if [ -z "${SLUG}" ]; then SLUG="no-message"; fi

          # 파일명 정의 (확장자 .tgz)
          TARGET_NAME="${DATE}_${SLUG}.tgz"
          
          # 압축 실행 (node_modules 제외)
          tar --exclude=.git \
              --exclude=.github \
              --exclude=node_modules \
              --exclude=.next/cache \
              -czf "${TARGET_NAME}" .

          echo "artifact_name=${TARGET_NAME}" >> "$GITHUB_OUTPUT"
          echo "✅ Prepared: ${TARGET_NAME}"

      # 5) scp 전송
      - name: SCP to EC2
        run: |
          mkdir -p ~/.ssh
          printf "%s" "${{ secrets.EC2_SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa

          # 디렉토리가 없으면 생성
          ssh -i ~/.ssh/id_rsa ${{ secrets.EC2_USER }}@${{ secrets.DEV_EC2_PUBLIC_IP }} "mkdir -p /home/ec2-user/nextjs"

          scp -o StrictHostKeyChecking=no \
                      -i ~/.ssh/id_rsa \
                      "${{ steps.prep_artifact.outputs.artifact_name }}" \
                      ${{ secrets.EC2_USER }}@${{ secrets.DEV_EC2_PUBLIC_IP }}:/home/ec2-user/nextjs/

  # cd:
  #   name: CD - Deploy to Dev Server
  #   runs-on: ubuntu-latest
  #   timeout-minutes: 30
  #   needs: ci-and-delivery

  #   steps:
  #     # SSH 키 설정
  #     - name: Setup SSH key
  #       id: setup_ssh
  #       shell: bash
  #       run: |
  #         mkdir -p ~/.ssh
  #         printf "%s" "${{ secrets.EC2_SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
  #         chmod 600 ~/.ssh/id_rsa
  #         ssh-keyscan -H ${{ secrets.DEV_EC2_PUBLIC_IP }} >> ~/.ssh/known_hosts

  #     # 배포
  #     - name: Deploy to port 3000
  #       id: deploy
  #       shell: bash
  #       run: |
  #         ssh -i ~/.ssh/id_rsa "${{ secrets.EC2_USER }}@${{ secrets.DEV_EC2_PUBLIC_IP }}" << 'SSH'
  #           set -euo pipefail

  #           echo "=== Next.js 배포 시작 ==="

  #           # 1) PM2 설치 확인 및 설치
  #           if ! command -v pm2 &> /dev/null; then
  #             echo "PM2가 설치되어 있지 않습니다. 설치 중..."
  #             sudo npm install -g pm2
  #           fi

  #           # 2) 배포 디렉토리 준비 및 압축 해제
  #           cd /home/ec2-user
  #           rm -rf nextjs
  #           mkdir -p nextjs
  #           tar -xzf nextjs.tgz -C nextjs/

  #           # 3) 의존성 설치
  #           cd nextjs
  #           export NODE_ENV=production
  #           export PORT=3000
  #           npm ci --production

  #           # 4) PM2로 프로세스 시작. &&는 전자가 성공해야 후자를 실행합니다. ||는 전자가 실패해야 후자를 실행합니다.
  #           echo "서비스 시작 (포트 3000)..."
  #           pm2 describe nextjs > /dev/null 2>&1 \
  #             && pm2 reload nextjs --update-env \
  #             || pm2 start npm --name nextjs -- start

  #           # PM2 프로세스 목록 저장. 이후 pm2가 재실행 되면 dump 파일을 참고하여 이전 버전의 프로세스를 재실행합니다.
  #           pm2 save

  #           echo "서비스 시작 대기 (10초)..."
  #           sleep 10

  #           echo "✅ 배포 완료"
  #         SSH

  #     # 1) 기동/프로세스 레벨: PM2 프로세스 확인
  #     - name: "Verify: 1) Process level (PM2)"
  #       id: verify_process
  #       shell: bash
  #       run: |
  #         ssh -i ~/.ssh/id_rsa "${{ secrets.EC2_USER }}@${{ secrets.DEV_EC2_PUBLIC_IP }}" << 'SSH'
  #           set -euo pipefail

  #           # PM2 프로세스 상태 확인
  #           if ! pm2 describe nextjs > /dev/null 2>&1; then
  #             echo "❌ PM2 프로세스 'nextjs'가 존재하지 않음"
  #             exit 1
  #           fi

  #           # 프로세스가 online 상태인지 확인
  #           STATUS=$(pm2 jlist | jq -r '.[] | select(.name=="nextjs") | .pm2_env.status')
  #           if [ "$STATUS" != "online" ]; then
  #             echo "❌ 프로세스 상태가 online이 아님: $STATUS"
  #             exit 1
  #           fi

  #           echo "✅ 프로세스 검증 통과: nextjs (status: $STATUS)"
  #         SSH

  #     # 2) 헬스체크
  #     - name: "Verify: 2) Healthcheck"
  #       id: verify_health
  #       shell: bash
  #       run: |
  #         ssh -i ~/.ssh/id_rsa "${{ secrets.EC2_USER }}@${{ secrets.DEV_EC2_PUBLIC_IP }}" << 'SSH'
  #           set -euo pipefail

  #           echo "포트 3000 헬스체크..."

  #           # 헬스체크 (최대 30초)
  #           for i in {1..10}; do
  #             if curl -fsS "http://localhost:3000/" > /dev/null 2>&1; then
  #               echo "✅ 헬스체크 통과"
  #               exit 0
  #             fi
  #             echo "시도 $i/10..."
  #             sleep 3
  #           done

  #           echo "❌ 헬스체크 실패 (30초 초과)"
  #           exit 1
  #         SSH